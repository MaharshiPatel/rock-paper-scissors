# This is a basic workflow to help you get started with Actions

name: Gihub Actions Maven Build Example

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
#  push:
#    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    env:
      JF_ARTIFACTORY_1: ${{ secrets.JF_ARTIFACTORY_SECRET_1 }}
      JFROG_BUILD_STATUS: PASS

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
       # setup JFrog CLI
      - name: Step 1-  Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v1


      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Step 2-  Checkout main branch from Github
        uses: actions/checkout@v2

      # Runs a single command using the runners shell
      - name: Step3 - Setup JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      # Runs a set of commands using the runners shell
      - name: Step4 - Ping RT
        run: |
          # Ping the server
          jfrog rt ping

      - name: Step5- Run Maven build
        env:
          SERVER_ID: swampup113
        run: |
          # Init JFrog CLI Maven config
          MVN_PATH=`which mvn` && export M2_HOME=`readlink -f $MVN_PATH | xargs dirname | xargs dirname`
          # Replace ‘my_art_server’ with your imported server
          #jfrog rt mvn-config --server-id-resolve=${{ secrets.JF_ARTIFACTORY_SECRET_1 }}  --repo-resolve-releases=libs-release-remote --repo-resolve-snapshots=libs-snapshot-remote
          jfrog rt mvn-config --server-id-resolve=$SERVER_ID  --repo-resolve-releases=maven-remote --repo-resolve-snapshots=maven-remote --repo-deploy-releases=backend-libs-release-local --repo-deploy-snapshots=backend-libs-snapshot-local
          # Build the maven project
          jfrog rt mvn clean install
      - name: Step6- Failure check
        run: |
          echo "JFROG_BUILD_STATUS=FAIL" >> $GITHUB_ENV
        if: failure()

      
      - name: Step7 - Publish to RT
        run: |
          # Build
          #jfrog rt mvn -B package --file pom.xml
          #jfrog rt mvn clean install -f pom.xml
          #jfrog rt mvn -f pom.xml
          # Get the java-version
          #version=$(jfrog -v | cut -d " " -f 3)
          #echo Build JFrog CLI version $version
          # Upload the jfrog-cli binary
          #jfrog rt u jfrog backend-libs-snapshot-local/jfrog-cli-releases/$version/
          # Add env vars
          jfrog rt bce
          # Collect VCS details from git and add them to the build
          jfrog rt bag
          #Publish build-info
          jfrog rt bp 
          # Scan build with JFrog Xray
          jfrog rt bs --fail=false > out.txt
          # Update the PR comment
          gh pr comment --body-file out.txt



      - name: Step5 - list files
        run: ls  -a
        
      - name: Step6 - What is in target folder
        run: |
           cd target
           ls  -a       
